name: Update Last Modified Dates
on:
  push:
    branches:
      - main

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Update last modified dates
        run: |
          if [ -d "_chapters" ]; then
            find _chapters -type f -name "*.md" | while read file; do
              last_modified=$(git log -1 --format="%ad" --date=iso "$file")

              # Check if last_modified_at exists and update it
              if grep -q "^last_modified_at:" "$file"; then
                sed -i "s/^last_modified_at: .*/last_modified_at: \"$last_modified\"/" "$file"
              else
                echo -e "\nlast_modified_at: \"$last_modified\"" >> "$file"
              fi
            done

            git config --global user.name "github-actions[bot]"
            git config --global user.email "github-actions@github.com"
            git diff --quiet || (git add _chapters && git commit -m "Update last modified dates" && git push)
          fi
